import q from"./class/checkform.js";import{utils as d}from"./utils/util.js";import{validationMessages as S}from"./utils/validation-messages.js";const m=document.getElementById("formContents"),w=document.querySelectorAll(".form-section"),b=document.getElementById("form-area"),l=document.getElementById("confirm-area"),f=document.getElementById("complete-area"),y=document.getElementById("formLoading"),a=document.getElementById("contact-form");let p=null,h=null;const g=a.getAttribute("action"),v=document.documentElement.lang||"ja";function D(){const t=new FormData(a),e={};return t.forEach((o,r)=>{r!=="attachment"&&(e[r]=o)}),e}function A(){const t=new FormData(a);return a.querySelectorAll("input[required], select[required], textarea[required]").forEach(e=>{e.name&&t.append("__required[]",e.name)}),t}function E(t){document.querySelectorAll(".error-message").forEach(e=>{e.textContent="",e.style.display="none"});for(const[e,o]of Object.entries(t)){if(!o)continue;const r=document.querySelector(`[data-error="${e}"]`);r&&(r.textContent=o,r.style.display="block")}}function u(t){t?y.classList.add("show"):y.classList.remove("show")}async function s(t){switch(window.scrollTo(0,0),w.forEach(e=>{e.classList.add("hide")}),m.querySelectorAll("[data-target]").forEach((e,o)=>{d.removeAction(e)}),t){case"form":b.classList.remove("hide");break;case"confirm":l.classList.remove("hide");break;case"complete":f.classList.remove("hide");break;default:break}await d.delay(100),m.querySelectorAll("[data-target]").forEach((e,o)=>{d.addAction(e,o)})}async function k(t){t.preventDefault();const e=a.querySelector(".btn_submit");if(!(e&&e.classList.contains("disable"))){u(!0),E({});try{const o=A();o.append("lang",v);const r=await fetch(`${g}/validate.php`,{method:"POST",body:o});if(!r.ok){const n=await r.text();console.error("Server error:",r.status,n),alert(`\u30B5\u30FC\u30D0\u30FC\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F (${r.status})`),s("form");return}const i=r.headers.get("content-type");if(!i||!i.includes("application/json")){const n=await r.text();console.error("Invalid response type:",i,n),alert("\u30B5\u30FC\u30D0\u30FC\u304B\u3089\u4E0D\u6B63\u306A\u30EC\u30B9\u30DD\u30F3\u30B9\u304C\u8FD4\u3055\u308C\u307E\u3057\u305F"),s("form");return}const c=await r.json();c.status==="confirm"?(p=c.token,l.innerHTML=c.html,s("confirm"),L()):c.status==="error"&&(E(c.errors),s("form"))}catch(o){console.error("Error:",o),alert("\u901A\u4FE1\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F\u3002")}finally{u(!1)}}}function L(){const t=l.querySelector(".btn.back");t&&t.addEventListener("click",()=>{s("form")});const e=l.querySelector(".btn.send");e&&e.addEventListener("click",x)}async function x(){u(!0);try{const t=await fetch(`${g}/send.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:p})});if(!t.ok){const r=await t.text();console.error("Server error:",t.status,r),alert(`\u30B5\u30FC\u30D0\u30FC\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F (${t.status})`),s("form");return}const e=t.headers.get("content-type");if(!e||!e.includes("application/json")){const r=await t.text();console.error("Invalid response type:",e,r),alert("\u30B5\u30FC\u30D0\u30FC\u304B\u3089\u4E0D\u6B63\u306A\u30EC\u30B9\u30DD\u30F3\u30B9\u304C\u8FD4\u3055\u308C\u307E\u3057\u305F"),s("form");return}const o=await t.json();o.status==="success"?(f.innerHTML=o.html,s("complete"),a.reset()):o.status==="error"&&(alert(o.message||"\u9001\u4FE1\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002"),s("form"))}catch(t){console.error("Error:",t),alert("\u901A\u4FE1\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F\u3002")}finally{u(!1)}}function B(){const t=document.getElementById("inquiry-type"),e=document.querySelectorAll(".recruit-only");t&&(t.addEventListener("change",o=>{const r=o.target.value==="recruit";e.forEach(i=>{const c=i.querySelectorAll("input, select, textarea");r?(i.style.display="block",c.forEach(n=>{n.dataset.originalRequired==="true"&&(n.required=!0)})):(i.style.display="none",c.forEach(n=>{n.required&&(n.dataset.originalRequired="true",n.required=!1),n.value=""}))}),h?.check()}),e.forEach(o=>{o.querySelectorAll("input, select, textarea").forEach(r=>{r.required&&(r.dataset.originalRequired="true",r.required=!1)})}))}async function I(){a&&(h=new q(a,S),B(),a.addEventListener("submit",k))}window.addEventListener("DOMContentLoaded",()=>{I()});
